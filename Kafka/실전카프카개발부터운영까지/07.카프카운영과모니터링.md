# Chapter 07 "카프카 운영과 모니터링"

## 1. 안정적인 운영을 위한 주키퍼와 카프카 구성

* 카프카는 애플리케이션이 워낙 안정적이기때문에, 클러스터를 구성해놓은 뒤 신경을 쓰지 않는 경우가 많다. 
* 하지만 장애를 대비해서 꼼꼼히 클러스터를 구성해 놓는것이 좋다.

### 1.1. 주키퍼 구성

* 주키퍼는 파티션과 브로커의 메타데이터를 저장하고 컨트롤러 서버를 선출하는 동작을 수행한다.
* 주키퍼의 역할을 카프카 내부에서 처리하면, 운영 효율성을 높여 더 많은 파티션을 처리할 수 있다.
* 최근들어 아파치 카프카 오픈소스 진영에서는 카프카의 코디네이터 역할을 하는 주키퍼의 의존성을 제거하려는 움직임이 있으나, 아직까지는 조합해서 사용하는 경우가 대부분이다.

#### 1) 주키퍼 서버 수량

* 주키퍼는 기본적으로 쿼럼(과반수)구성을 기반으로 동작하므로 반드시 홀수로 구성해야 한다. 최소 3개.
* 카프카의 사용량과 용도에 따라 주키퍼 서버 수를 정하면 된다.
    * 예시) 3 - 과반수인 2를 추족할 수 있는 최대 1대까지의 주키퍼 장애를 허용한다.
    * 예시) 5 - 2까지 장애를 허용한다. (높은 안정성 확보)

#### 2) 주키퍼 하드웨어

* 키퍼는 높은 하드웨어 리소스를 요구하지 않으므로 주키퍼의 물리적인 메모리 크기는 4~8GB로 구성한다.
* 디스크는 240G 또는 480G / 쓰기 성능이 좋은 SSD 디스크를 추천한다. <br>
(주키퍼는 트랜잭션이나 스냅샷 로그를 로컬 디스크에 저장하기 때문이다.)
* 주키퍼에서 필요한 힙메모리 크기는 일반적으로 1~4GB / 나머지는 운영체제 영역 등에서 사용하게 된다.<br>
→ 과도한 물리 메모리를 장착하는 것은 메모리를 낭비한다.

#### 3) 주키퍼 배치

* 물리 서버 배치
    * 데이터 센터 내에 랙 마운트를 할때, 하나의 랙에 모든 주키퍼 서버를 마운트해 배치하는 것은 매우 위험하다. 
    * 주키퍼를 각기 다른 랙에 분산 배치해야 한다.
* AWS와 같은 클라우드 환경
    * EC2 인스턴스를 가능한 한 2개 또는 3개의 가용 영역에 분산하는 구성을 추천한다.

### 1.2. 카프카 구성

#### 1) 카프카 서버 수량

* 주키퍼와 다른 점 : 쿼럼 방식의 구성이 필요하지 않아 홀수일 필요가 없어 4대, 6대 등으로도 구성이 가능하다. 
* 카프카에서 추천하는 안정적인 리플리케이션 팩터수인 3으로 토픽을 구성하기 위해서는 최소 3대의 브로커가 필요하므로, 최소 카프카 서버는 3대이다.
* 카프카는 확장성이 좋기때문에 현재 꼭 필요한 수량만큼만 구성한다.

#### 2) 카프카 하드웨어

* 주키퍼와 다른 점 : 카프카의 CPU 사용률은 높은 편이다.
* 프로듀서나 컨슈머의 처리량을 높이기 위해 배치와 압축 기능을 많이 적용하여 많은 리소스가 요구된다.
* 최고의 고성능 CPU만 고집할 필요 없이 코어 수가 많은 CPU로 구성하는 것을 권장한다.
* 메모리는 32GB ~ 256GB까지 다양하게 선택할수 있고, 카프카에서 사용하는 JVM 힙 크기가 일반적으로 6GB 정도이므로 이보다 큰 물리 메모리가 필요하다.

#### 3) 카프카 배치

* 여러 서버에 분산하여 멀티 가용 영역을 구성하는 것을 추천한다.

## 2. 모니터링 시스템 구성

* 목표: 카프카의 현재 상태를 정확하게 파악하여, 발생 가능성이 있는 이슈나 문제를 사전에 예측해 미리 조치할 수 있도록 하고 신속하게 장애를 처리한다.
* 모니터링 방법
    1. 애플리케이션 로그 분석
    1. JMX를 이용해 브로커들의 메트릭 정보를 확인

### 2.1. 애플리케이션으로서 카프카의 로그 관리와 분석

* 카프카 애플리케이션에서 발생하는 모든 로그를 로컬 디스크에 기록한다.
* 기본적으로 자바 기반의 로깅 유틸리티인 log4j를 이용하여, 레벨별로 로깅이 가능하다.
* 로그에서 많은 양의 데이터가 나올 수 있기 때문에, 로그 레벨 변경하기 전에 여유 디스크 공간이 충분한지 확인해야한다.

### 2.2. JMX를 이용한 카프카 메트릭 모니터링

* JMX: 자바로 만든 애플리케이션의 모니터링을 위한 도구를 제공하는 자바 API
    * MBean(Managed Bean)이라는 객체로 표현된다.
    * JMX를 이용해 카프카의 주요 메트릭들을 그래프와 같은 형태로 확인할 수 있다.
* 준비 절차
    1. 브로커에 JMX 포트를 오픈한다.
    1. JMX에서 제공하는 메트릭 정보를 관리자가 GUI 형태로 볼 수 있도록 구성한다. (프로메테우스/익스포터)

![카프카 모니터링](https://miro.medium.com/max/1100/1*jL6bP5xQhCz-Q0J_tk7-3g.png)

* 단계
    * Kafka-Exporter와 JMX Export는 카프카 클러스터로부터 브로커 metrics를 수집한다.
    * 프로메테우스는 이러한 metrics를 수집해 시계열 데이터베이스에 저장한다.
    * 그라파나는 프로메테우스와 연결되어 대시보드를 제공한다.
* 개념 정리
    * 프로메테우스
        * 메트릭 기반 모니터링 시스템. 
        * 프로메테우스가 주기적으로 대상 서버의 메트릭값(지표)을 가져와 자신의 DB에 저장한다.
    * 그라파나
        * 대시보드를 만들기 위한 도구.
    * 익스포터
        * 프로메테우스의 모니터링 방식은 push가 아닌 pull 이므로, 모니터링 대상 서버에 자신의 메트릭 정보를 보여줄 수 있는 익스포터를 설치해야 한다.

## Reference

* https://zeroco.tistory.com/111
* https://danielmrosa.medium.com/monitoring-kafka-b97d2d5a5434